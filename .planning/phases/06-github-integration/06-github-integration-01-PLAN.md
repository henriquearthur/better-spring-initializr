---
phase: 06-github-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/lib/github-oauth-client.ts
  - src/server/lib/github-oauth-session.ts
  - src/server/functions/github-oauth.ts
  - src/components/workspace/github-auth-panel.tsx
  - src/components/workspace/workspace-shell.tsx
autonomous: true
user_setup:
  - service: github
    why: "OAuth credentials and callback registration for GitHub sign-in"
    env_vars:
      - name: GITHUB_CLIENT_ID
        source: "GitHub Settings -> Developer settings -> OAuth Apps -> Client ID"
      - name: GITHUB_CLIENT_SECRET
        source: "GitHub Settings -> Developer settings -> OAuth Apps -> Generate client secret"
      - name: GITHUB_OAUTH_CALLBACK_URL
        source: "OAuth App callback URL value (must match app callback)"
      - name: GITHUB_SESSION_SECRET
        source: "Local app secret generated by user (32+ random chars)"
    dashboard_config:
      - task: "Create OAuth App with callback URL ending in /api/github/oauth/callback"
        location: "GitHub Settings -> Developer settings -> OAuth Apps"
must_haves:
  truths:
    - "User can start GitHub OAuth from the workspace and sees why repo permissions are requested"
    - "After approving access, the workspace shows connected GitHub account state"
    - "OAuth token stays server-side in secure httpOnly session storage and is not exposed to client JavaScript"
  artifacts:
    - path: "src/server/functions/github-oauth.ts"
      provides: "OAuth start/callback/session/disconnect server functions with sanitized responses"
      exports: ["startGitHubOAuth", "completeGitHubOAuth", "getGitHubOAuthSession", "disconnectGitHubOAuth"]
    - path: "src/server/lib/github-oauth-session.ts"
      provides: "State+PKCE validation and encrypted/signed session cookie helpers"
      contains: "setGitHubSessionCookie"
    - path: "src/components/workspace/github-auth-panel.tsx"
      provides: "Workspace UI for connect/disconnect and permission explanation"
      contains: "GitHubAuthPanel"
  key_links:
    - from: "src/components/workspace/github-auth-panel.tsx"
      to: "src/server/functions/github-oauth.ts"
      via: "connect/disconnect/session server function calls"
      pattern: "startGitHubOAuth|getGitHubOAuthSession|disconnectGitHubOAuth"
    - from: "src/server/functions/github-oauth.ts"
      to: "src/server/lib/github-oauth-session.ts"
      via: "state verification and secure cookie persistence"
      pattern: "verifyOAuthState|setGitHubSessionCookie"
    - from: "src/server/functions/github-oauth.ts"
      to: "src/server/lib/github-oauth-client.ts"
      via: "OAuth code exchange and identity lookup"
      pattern: "exchangeCodeForToken|fetchAuthenticatedUser"
---

<objective>
Implement the secure GitHub OAuth foundation so users can connect their account from the workspace before pushing generated projects.

Purpose: Satisfy INFR-03 and the authentication portion of OUTP-03 while preserving the BFF-first, sanitized-error approach established in earlier phases.
Output: OAuth client/session utilities, server functions for connect lifecycle, and workspace auth panel integration.
</objective>

<execution_context>
@/Users/henriquearthur/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/henriquearthur/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md
@src/server/functions/get-initializr-metadata.ts
@src/components/workspace/workspace-shell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build GitHub OAuth client and secure server-side session helpers</name>
  <files>src/server/lib/github-oauth-client.ts, src/server/lib/github-oauth-session.ts</files>
  <action>Create a GitHub OAuth client utility that builds authorization URL (scope `repo read:org`, state, PKCE S256 challenge), exchanges callback code for token, and fetches authenticated user identity plus org memberships needed for repository owner selection. Add a separate session helper module that validates state/code_verifier and persists OAuth session in a secure cookie (`httpOnly`, `secure` in production, `sameSite=lax`, bounded max-age). Do not store access token in localStorage, URL params, or client-visible JSON; keep token server-only. Normalize upstream failures into typed domain errors for sanitized UI messaging.</action>
  <verify>Run `npm test -- src/server/lib/github-oauth-client.test.ts src/server/lib/github-oauth-session.test.ts` after adding coverage for URL generation, token exchange error mapping, state mismatch rejection, and cookie option assertions.</verify>
  <done>OAuth primitives are reusable, tested, and enforce secure server-side token handling.</done>
</task>

<task type="auto">
  <name>Task 2: Implement OAuth lifecycle server functions with sanitized responses</name>
  <files>src/server/functions/github-oauth.ts</files>
  <action>Add server functions for full OAuth lifecycle: `startGitHubOAuth` (returns auth URL and sets state verifier context), `completeGitHubOAuth` (verifies state, exchanges code, stores session cookie), `getGitHubOAuthSession` (returns connected user/org summary without exposing token), and `disconnectGitHubOAuth` (clears cookie). Keep response contracts discriminated (`ok: true/false`) and mirror existing metadata-function error hygiene so no raw GitHub response body leaks to client. Ensure callback handling supports browser redirect completion for `/api/github/oauth/callback` flow and gracefully handles denied/cancelled authorization.</action>
  <verify>Run `npm test -- src/server/functions/github-oauth.test.ts` and `npm run build`; confirm success path sets session and failure paths return sanitized `GITHUB_AUTH_FAILED`-style errors.</verify>
  <done>Workspace can establish, read, and clear GitHub OAuth session entirely through secure server functions.</done>
</task>

<task type="auto">
  <name>Task 3: Add workspace GitHub auth panel with permission explanation</name>
  <files>src/components/workspace/github-auth-panel.tsx, src/components/workspace/workspace-shell.tsx</files>
  <action>Create `GitHubAuthPanel` in the output/actions area with: clear copy explaining requested permissions (repo creation/push), `Connect GitHub` action, connected-account badge, and `Disconnect` action. On connect, trigger OAuth start flow and round-trip callback completion, then refresh session status from `getGitHubOAuthSession`. Wire this panel into `WorkspaceShell` without removing existing configuration/preview scaffolding. Avoid implementing repository push controls in this plan; those belong to plan 02.</action>
  <verify>Run `npm run dev` and perform manual flow: click connect -> authorize on GitHub -> return to app -> panel shows connected account/org count; click disconnect -> connected state clears.</verify>
  <done>User-visible GitHub authentication is complete with clear permission context and secure session-backed state.</done>
</task>

</tasks>

<verification>
1. `npm test -- src/server/lib/github-oauth-client.test.ts src/server/lib/github-oauth-session.test.ts src/server/functions/github-oauth.test.ts` passes.
2. `npm run build` succeeds with OAuth server functions and auth panel wiring.
3. Browser flow verifies token secrecy: devtools/client state never shows raw GitHub access token; session survives refresh until disconnect.
</verification>

<success_criteria>
- INFR-03 satisfied: OAuth authorization is handled through server functions with secure cookie-backed session management.
- Phase 6 auth requirement satisfied: user can connect/disconnect GitHub and understand requested permissions.
- Repo push plan can rely on a stable `getGitHubOAuthSession` contract without re-implementing auth.
</success_criteria>

<output>
After completion, create `.planning/phases/06-github-integration/06-github-integration-01-SUMMARY.md`
</output>
